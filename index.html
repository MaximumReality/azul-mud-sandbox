<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Azul & Mochkil: Maximum Reality</title>
<style>
  body {
    background: #0a0a23;
    color: #00ffff;
    font-family: monospace;
    margin: 0;
    padding: 0;
    text-shadow: 0 0 6px #00ffff;
    overflow-x: hidden;
  }
  .container {
    max-width: 420px;
    margin: auto;
    padding: 12px 12px 80px 12px;
    position: relative;
  }
  @keyframes glitch-flicker {
    0% { opacity: 0.9; }
    50% { opacity: 1; }
    100% { opacity: 0.9; }
  }
  .vault-active { animation: glitch-flicker 0.2s infinite; }
  h1 {
    margin-top: 80px;
    text-align: center;
    color: #ffcc00;
    text-shadow: 0 0 10px #ffcc00;
    font-size: 1.4em;
  }
  #story { min-height: 140px; margin: 10px 0; line-height: 1.4; }
  #loading, #dice { color: #ff66cc; text-shadow: 0 0 6px #ff66cc; font-weight: bold; }
  #dice { cursor: pointer; font-size: 1.5em; display: inline-block; margin-bottom: 10px; }
  #actions button {
    display: block; width: 100%; margin: 6px 0; padding: 12px;
    font-size: 1em; background: #111144; color: #fff; 
    border: 1px solid #00ffff; border-radius: 4px;
  }
  #inventory { margin-top: 15px; color: #ffcc66; font-size: 0.9em; border-top: 1px solid #333; padding-top: 10px; }
  #inputRow { display: flex; gap: 6px; margin-top: 15px; }
  #inputRow input { flex: 1; padding: 10px; background: #111133; color: #00ffff; border: 1px solid #00ffff; border-radius: 4px; }
  #inputRow button { background: #333366; color: #fff; border: 1px solid #00ffff; padding: 10px; border-radius: 4px; }
  img.sprite { position: absolute; width: 64px; image-rendering: pixelated; z-index: 5; transition: all 0.3s ease; }
  #azul { top: 10px; left: 10px; filter: drop-shadow(0 0 5px #00ffff); }
  #mochkil { top: 10px; right: 10px; filter: drop-shadow(0 0 5px #ff66cc); }
</style>
</head>

  <body>
<div class="container">
  <img id="azul" class="sprite" src="https://raw.githubusercontent.com/MaximumReality/azul-story-cyoa-sandbox/main/azul.png">
  <img id="mochkil" class="sprite" src="https://raw.githubusercontent.com/MaximumReality/azul-story-cyoa-sandbox/main/mochkil.png">

  <h1>Azul & Mochkil: Maximum Reality</h1>

  <div id="story"></div>
  <div id="loading" style="display:none">ðŸ’¾ SYNCING_REALITY...</div>
  <div id="dice">ðŸŽ² Roll Dice</div>
  <div id="actions"></div>
  <div id="inventory">ðŸŽ’ DATA_PACKETS: EMPTY</div>

  <div id="inputRow">
    <input id="userInput" placeholder="Enter command">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const rooms = {
  lab: { 
    description: "You are in the Glowing Lab. Test tubes bubble with quantum foam.", 
    actions:["Inspect test tubes","Give elixir to Azul","Go to Library","Go to Courtyard", "Go to Pantry"] 
  },
  pantry: { 
    description: "The Secret Pantry. Chef Mochkil is guarding the exit to the Forest.", 
    actions:["Take cookie","Give cookie to Mochkil","Return to Lab"] 
  },
  potionChamber: { 
    description: "A hidden chamber filled with glowing potions.", 
    actions:["Take sparkling elixir","Return to Lab"] 
  },
  library: { 
    description: "Endless shelves of dusty books, some levitating mysteriously.", 
    actions:["Read a book","Search for spell scroll","Go to Potion Chamber","Return to Lab"] 
  },
  courtyard: { 
    description: "A courtyard with a fountain. You can smell the distant Forest.", 
    actions:["Pick a mushroom","Throw coin in fountain","Return to Lab"] 
  },
  forest: { 
    description: "The Mysterious Forest. The trees whisper binary secrets.", 
    actions:["Pick glowing mushroom","Talk to squirrel","Explore deeper","Trade mushroom","Return to Courtyard"] 
  },
  vault: { 
    description: "MAINFRAME_HEART. The Doom Loop is playing on every screen.", 
    actions:["Watch Doom Loop", "RESTART_SIMULATION", "ENTER_MAINFRAME"] 
  }
};
let currentRoom = 'lab';
let inventory = [];
let typing = false;

const storyEl = document.getElementById('story');
const actionsEl = document.getElementById('actions');
const inventoryEl = document.getElementById('inventory');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const loadingEl = document.getElementById('loading');

const npcs = {
  azul: { name: "Dr. Azul", location: "lab", dialogue: "Azul adjusts his goggles. 'Quantum fibers are stable.'" },
  mochkil: { name: "Chef Mochkil", location: "pantry", dialogue: "Mochkil licks a wooden spoon. 'Cookies are currency!'" },
  squirrel: { name: "Forest Squirrel", location: "forest", dialogue: "The squirrel chitters: 'The Ghost Broom is hidden!'" }
};

// --- Core Helper Functions ---
function showLoading(cb){ 
  loadingEl.style.display='block'; 
  setTimeout(()=>{ loadingEl.style.display='none'; if(cb) cb(); }, 400); 
}

function typeWriter(text, cb){ 
  if(typing) return; 
  typing = true; 
  storyEl.textContent = ''; 
  let i = 0; 
  (function step(){ 
    if(i < text.length){ 
      storyEl.textContent += text[i++]; 
      setTimeout(step, 25); 
    } else { 
      typing = false; 
      if(cb) cb(); 
    } 
  })(); 
}

// --- Rendering functions ---
function updateInventory(){ 
  inventoryEl.innerHTML = "ðŸŽ’ <span style='color:#00ffff'>DATA_PACKETS:</span> " + 
    (inventory.length ? inventory.join(' | ') : 'EMPTY'); 
}

function renderActions(){ 
  actionsEl.innerHTML = ''; 
  rooms[currentRoom].actions.forEach(a => { 
    const b = document.createElement('button'); 
    b.textContent = a; 
    b.onclick = () => handleAction(a); 
    actionsEl.appendChild(b); 
  }); 
}

function renderRoom(){ 
  actionsEl.innerHTML = ''; // Prevent double-clicks
  showLoading(() => { 
    typeWriter(rooms[currentRoom].description, () => { 
      renderActions();
      // Manage Sprite Visibility
      document.getElementById('azul').style.display = (npcs.azul.location === currentRoom) ? "block" : "none";
      document.getElementById('mochkil').style.display = (npcs.mochkil.location === currentRoom) ? "block" : "none";
    }); 
  }); 
}
function handleAction(action){
  if(typing) return;
  const input = action.toLowerCase();
  actionsEl.innerHTML = ''; // Clear UI immediately

  // --- NPC Interaction ---
  if(input.startsWith("talk to ")){
    const target = input.replace("talk to ", "").trim();
    if(target === "squirrel" && currentRoom === 'forest') {
      typeWriter(npcs.squirrel.dialogue, renderActions);
    } else if(npcs[target] && npcs[target].location === currentRoom) {
      typeWriter(npcs[target].dialogue, renderActions);
    } else {
      typeWriter(`SYSTEM: ${target} not found in this sector.`, renderActions);
    }
    return;
  }

  // --- Item & Quest Logic ---
  if(action.includes("Take cookie") && currentRoom==='pantry'){
    if(!inventory.includes("cookie")){
      inventory.push("cookie"); updateInventory();
      typeWriter("You grab a cookie. Mochkil's whiskers twitch with joy!", renderActions);
    } else { typeWriter("You already have a cookie.", renderActions); }
    return;
  }

  if(action.includes("Give cookie to Mochkil") && currentRoom==='pantry'){
    if(inventory.includes("cookie")){
      inventory = inventory.filter(i => i !== "cookie"); updateInventory();
      typeWriter("Mochkil eats the cookie. 'Delicious! The Forest is open.'", () => {
        if (!rooms.courtyard.actions.includes("Go to Forest")) {
          rooms.courtyard.actions.push("Go to Forest");
        }
        renderActions();
      });
    } else { typeWriter("Mochkil hisses: 'No cookie, no entry.'", renderActions); }
    return;
  }

  if(action.includes("Take sparkling elixir") && currentRoom==='potionChamber'){
    if(!inventory.includes("sparkling elixir")){
      inventory.push("sparkling elixir"); updateInventory();
      typeWriter("The elixir glows in your hand. Azul will want this.", renderActions);
    } return;
  }

  if(action.includes("Give elixir to Azul") && currentRoom==='lab'){
    if(inventory.includes("sparkling elixir")){
      inventory = inventory.filter(i => i !== "sparkling elixir"); updateInventory();
      typeWriter("Azul drinks. 'Power restored! I sense a Ghost Broom in the Forest.'", () => {
        if(!rooms.forest.actions.includes("Search for Ghost Broom")) rooms.forest.actions.push("Search for Ghost Broom");
        renderActions();
      });
    } else { typeWriter("Azul sighs. 'I need that sparkling elixir...'", renderActions); }
    return;
  }

  // --- Room Navigation ---
  const roomKeys = Object.keys(rooms);
  const destination = roomKeys.find(key => input.includes(key.toLowerCase()) && key !== 'vault');
  if (destination) {
    currentRoom = destination;
    renderRoom();
    return;
  }

  // --- Fallback ---
  typeWriter(`You attempt to ${action}. The simulation remains stable.`, renderActions);
}
// --- Dice & Randomizers ---
function rollDice(){ return Math.floor(Math.random()*6)+1; }

const diceEl = document.getElementById('dice');
diceEl.onclick = () => {
  if(typing) return;
  const roll = rollDice();
  typeWriter(`ðŸŽ² DATA_RECOVERY: Rolled ${roll}. Re-syncing UI...`, renderActions);
  if(roll === 6) {
    typeWriter("ðŸŽ² CRITICAL HIT! Mochkil triggers a Snack Attack!", startPotatoRain);
  }
};

// --- Special Effects ---
function startPotatoRain() {
  const count = 25;
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const p = document.createElement('div');
      p.textContent = 'ðŸ¥”';
      p.style.cssText = `position:fixed; top:-50px; left:${Math.random()*100}vw; font-size:24px; z-index:1000; pointer-events:none; transition: transform 2s linear;`;
      document.body.appendChild(p);
      setTimeout(() => {
        p.style.transform = `translateY(${window.innerHeight + 100}px) rotate(360deg)`;
        setTimeout(() => p.remove(), 2500);
      }, 100);
    }, i * 150);
  }
}

// --- Specific Action Overrides ---
// (Add these to the end of handleAction logic if needed)
if(input === "watch doom loop") {
  typeWriter("The screens pulse. The starch is eternal.", () => {
    document.body.style.background = "radial-gradient(circle, #ff00ff, #0a0a23)";
    startPotatoRain();
  });
}

if(input === "restart_simulation") location.reload();
if(input === "enter_mainframe") window.location.href = "https://maximumreality.xyz";

// --- Input Handling ---
sendBtn.onclick = () => {
  const v = userInput.value.trim();
  if(v) handleAction(v);
  userInput.value = '';
};

userInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendBtn.click();
});

// --- Boot Sequence ---
updateInventory();
renderRoom();
</script>
</body>
</html>
